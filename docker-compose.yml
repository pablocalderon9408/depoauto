services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: depoauto
      POSTGRES_USER: depoauto
      POSTGRES_PASSWORD: depoauto
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  minio:
    image: minio/minio:latest
    command: server /data --console-address :9001
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    ports:
      - "9002:9000"
      - "9003:9001"
    restart: unless-stopped

  createbuckets:
    image: minio/mc:latest
    depends_on:
      - minio
    entrypoint: >-
      /bin/sh -c "
      until (mc alias set local http://minio:9000 minioadmin minioadmin); do echo 'waiting for minio...' && sleep 2; done; \
      mc mb -p local/depoauto || true; \
      mc anonymous set download local/depoauto || true; \
      echo 'Buckets ready.'; exit 0"

  web:
    build: .
    depends_on:
      - db
      - minio
    environment:
      DATABASE_URL: postgres://depoauto:depoauto@db:5432/depoauto
      DEBUG: "1"
      USE_S3: "true"
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      AWS_STORAGE_BUCKET_NAME: depoauto
      AWS_S3_ENDPOINT_URL: http://minio:9000
      AWS_S3_REGION_NAME: us-east-1
      AWS_S3_ADDRESSING_STYLE: path
      AWS_QUERYSTRING_AUTH: "false"
      ALLOWED_HOSTS: localhost,127.0.0.1
      CSRF_TRUSTED_ORIGINS: http://localhost:8000
    ports:
      - "8000:8000"
    volumes:
      - .:/app

volumes:
  db_data:
  minio_data:


